<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Secure File Storage (Flask + AES-256-GCM)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body class="bg-light">
    <div class="container py-5">
      <h1 class="mb-4">Secure File Storage (Flask + AES-256-GCM)</h1>

      <div class="alert alert-info">
        <strong>Important:</strong> Set environment variable <code>SFS_MASTER_KEY</code> (base64 urlsafe 32-byte key) before starting the server.
        Use the Generate Key button to produce one for testing (copy it to your Render env). Do NOT commit keys to git.
      </div>

      <div class="card mb-4">
        <div class="card-body">
          <form method="post" action="{{ url_for('upload') }}" enctype="multipart/form-data">
            <div class="mb-3">
              <label class="form-label">Select file to encrypt and store</label>
              <input class="form-control" type="file" name="file" required>
            </div>
            <button class="btn btn-primary" type="submit">Upload & Encrypt</button>
            <a class="btn btn-secondary" href="{{ url_for('list_files') }}">View Stored Files</a>
          </form>
        </div>
      </div>

      <div class="mb-3">
        <button id="genKey" class="btn btn-outline-secondary">Generate Test Master Key</button>
        <small class="text-muted ms-2">(For local testing only â€” copy into SFS_MASTER_KEY env on server)</small>
      </div>

      <div id="generatedKey" class="mt-2"></div>

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="mt-3">
            {% for category, msg in messages %}
              <div class="alert alert-{{ category }}">{{ msg }}</div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      <footer class="mt-5 text-muted">
        Note: Files are stored in <code>{{ storage_dir }}</code>. To persist on Render use Volumes or S3.
      </footer>
    </div>

    <script>
    document.getElementById("genKey").addEventListener("click", async function(){
      const resp = await fetch("/generate-key", {method: "POST"});
      const j = await resp.json();
      const el = document.getElementById("generatedKey");
      el.innerHTML = "<div class='card'><div class='card-body'><strong>Master Key (copy to env):</strong><div class='mt-2'><code style='word-break:break-all;'>"+j.master_key+"</code></div></div></div>";
    });
    </script>
  </body>
</html>
